{% extends "plantmate/../plantmate/base.html" %}
{% load staticfiles %}
{% block head_block %}

    {% block title_block %}
        Business List
    {% endblock %}
{% endblock %}

{% block body_block %}
    <div class="jumbotron">
        <h1>Find a plant shop near you...</h1>
    </div>
    <div class="background_space_medium_rare">
        <div class="business_details" style="margin-left: 20%">
            <h5 id="card-title"></h5>
            <p id="business-address"></p>
        </div>
        <div id="map_loading" style="text-align: center"><p>map loading . . . </p></div>

        <div id="googleMap" style="width:600px;height:400px;left: 20%; right: 20%; "></div>
        {% if user.is_authenticated %}
            <div style="margin-left: 20%;margin-bottom: 70px">
                <br>
                <p>If you can't find the business you're looking for, you can

                    <a href="{% url 'add_business' %}">add a
                        new business</a>
                    <br/></p>
            </div>
        {% endif %}
    </div>
    <script>
        function addMarkers() {
            {%  for business in businesses %}
                addMarker({
                        lat: Number("{{ business.lat }}"),
                        lng: Number("{{ business.long }}")
                    }, "<a href=\"" + "{% url 'business-list' %}{{ business.slug }}" + "\">" + "{{ business.name }}" + "<\/a>", "{{ business.address | escapejs }}"
                );
            {%  endfor %}
        }
    </script>
    <script>
        let map;

        function initMap() {
            // default map location set to Glasgow
            const glasgow = {
                center: {lat: -34.397, lng: 150.644},
                zoom: 6,
            };
            //if there is geolocation:
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const here = {
                        center: {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        },
                        zoom: 13,
                    };
                    map = new google.maps.Map(document.getElementById("googleMap"), here);
                    addMarkers();
                    document.getElementById("map_loading").style.display = "none";
                });
            } else {
                // if there isn't any geolocation let's center on Glasgow:
                map = new google.maps.Map(document.getElementById("googleMap"), glasgow);
                addMarkers();
                document.getElementById("map_loading").style.display = "none";
            }
        }

        // function for adding markers
        function addMarker(coords, businessLink, businessAddress) {
            let marker = new google.maps.Marker({
                position: coords,
                map: map,
            });
            let infoWindow = new google.maps.InfoWindow({
                content: businessLink,
            });
            marker.addListener('click', function () {
                infoWindow.open(map, marker);
                document.getElementById("card-title").innerHTML = businessLink;
                document.getElementById("business-address").innerText = businessAddress;
            });
        }


    </script>

    {# <script type="text/javascript" src={% static "javascript/allLocalBusinesses.js" %}></script>#}
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1_mwAa6UhCMVkPr4XIk-XFSXlD0Fwkmw&callback=initMap"></script>
{% endblock %}